<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Baseball Player Simulator</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <!-- 인트로 -->
        <section id="screen-intro" class="screen active">
            <div class="center-box">
                <h1>Baseball Player Simulator</h1>
                <p>야구 선수 시뮬레이션</p>
                <button id="btn-start">시작하기</button>
            </div>
        </section>

        <!-- 캐릭터 설정 -->
        <section id="screen-creation" class="screen">
            <h2>선수 생성</h2>

            <div class="creation-layout">

                <!-- 입력 패널 -->
                <div class="panel">
                    <div class="form-group">
                        <label>이름</label>
                        <input type="text" id="input-name">
                    </div>

                    <div class="form-group">
                        <label>연차</label>
                        <div id="career-tags" class="tag-container">
                            <!-- JS로 태그 생성 -->
                        </div>  
                    </div>

                    <div class="form-group">
                        <label>포지션</label>
                         <div id="position-tags" class="tag-container">
                            <!-- JS로 태그 생성 -->
                        </div>  
                    </div>

                    <div class="form-group">
                        <label>성격</label>
                        <div id="personality-tags" class="tag-container">
                        <!-- JS로 태그 생성 -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                        <input type="checkbox" id="input-married">기혼</label>
                    </div>

                    <button id="btn-add-char" style="margin-bottom: 10px;">선수 등록</button>
                    <div class="data-io-group">
                        <button id="btn-export" class="btn-io">DATA SAVE (내보내기)</button>
                        <button id="btn-import" class="btn-io">DATA LOAD (불러오기)</button>
                        <input type="file" id="file-input" accept=".json" style="display:none">
                    </div>

                </div>

                <!-- 리스트 -->
                <div class="panel">
                    <h3>등록된 선수</h3>
                    <div id="char-list"></div>
                </div>

            </div>

            <button id="btn-to-relation" style="margin-top: 10px;" onclick="
                document.getElementById('screen-creation').classList.remove('active');
                document.getElementById('screen-relation').classList.add('active');
                refreshRelationSelectors();
            ">
                관계 설정으로 이동
            </button>
        </section>

        <!-- 관계설정 -->
        <section id="screen-relation" class="screen">
            <h2>관계 설정</h2>

            <div class="relation-layout">

                <div class="panel">
                    <div class="form-group">
                        <label>주체</label>
                        <select id="select-from"></select>
                    </div>

                    <div class="form-group">
                        <label>대상</label>
                        <select id="select-to"></select>
                    </div>

                    <div class="form-group">
                        <label>감정</label>
                        <div class="emotion-group">
                            <button class="emotion-btn" data-emotion="interest">호감</button>
                            <button class="emotion-btn" data-emotion="dislike">혐오</button>
                            <button class="emotion-btn" data-emotion="obsession">집착</button>
                            <button class="emotion-btn" data-emotion="neutral">관심없음</button>
                        </div>
                    </div>
                    <button id="btn-set-relation">관계 등록</button>
                </div>
                <div class="relation-table-wrapper">
                    <h3>관계 표</h3>
                    <table id="relation-table">
                        <!-- JS로 생성 -->
                    </table>
                </div>

            </div>

            <button id="btn-to-game" style="margin-top: 10px;" onclick="
                document.getElementById('screen-relation').classList.remove('active');
                document.getElementById('screen-game').classList.add('active');
            ">
                메인 시뮬 시작
            </button>
        </section>

        <!-- 메인 시뮬 -->
        <section id="screen-game" class="screen">
            <header class="game-header-top">
                <h2>메인 시뮬</h2>
                <span id="day-display-static">DAY 1</span>
            </header>

            <div class="mobile-tabs">
                <button id="tab-log" class="tab-btn active" onclick="switchTab('log')">로그 보기</button>
                <button id="tab-status" class="tab-btn" onclick="switchTab('status')">선수 상태</button>
            </div>

            <div class="game-main-content">
                <div id="log-section" class="content-box active">
                    <div id="event-container" class="panel event-panel" style="display:none;"></div>
                    <button id="btn-show-all-logs" class="small-link">← 이전로그보기</button>
                    <div id="log-area"></div>
                </div>
                
                <div id="status-section" class="content-box">
                    <h3>선수 상태</h3>
                    <div id="character-status-list"></div>
                    <div id="relation-modal" class="modal-overlay" style="display: none;">
                        <div class="modal-content">
                            <h3 id="modal-player-name">선수 관계도</h3>
                            <div id="modal-relation-list" class="modal-list">
                                </div>
                            <div class="modal-footer">
                                <button id="btn-close-modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="game-footer-controls">
                <button id="btn-next-day">다음 날 진행</button>
                <button id="btn-export-log" onclick="exportLogsAsTXT()">
                로그 txt 저장
                </button>
            </footer>
        </section>

        <script src="script.js"></script>

        <script>
            function renderLogs() {
            const area = document.getElementById("log-area");
            if (!area) return;
            area.innerHTML = "";

            // showAllLogs가 true면 모든 로그, 아니면 lastDay 또는 currentDay만 표시
            const visibleDay = (typeof showAllLogs !== 'undefined' && showAllLogs) ? null : ((typeof lastDay !== 'undefined' && lastDay !== null) ? lastDay : currentDay);

            gameLogs.forEach(log => {
                if (visibleDay === null || log.day === visibleDay || log.day === currentDay) {
                    const div = document.createElement("div");
                    div.className = "log-entry";
                    div.textContent = `[DAY ${log.day}] ${log.text}`;
                    area.appendChild(div);
                }
            });

            area.scrollTop = area.scrollHeight;
            }
        </script>
        <script>
            /* TXT 로그 저장 */
            function exportLogsAsTXT() {
                // 수정: gameLogs -> state.gameLogs
                if (!state.gameLogs || state.gameLogs.length === 0) {
                    alert("저장할 로그가 없습니다.");
                    return;
                }

                const content = state.gameLogs
                    .map(l => `[DAY ${l.day}] ${l.text}`)
                    .join("\n");

                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "game_log.txt";
                a.click();

                URL.revokeObjectURL(url);
            }

            /* JSON 데이터 저장 (내보내기) */
            document.getElementById("btn-export").onclick = () => {
                // 수정: state 객체 내부의 변수를 참조하도록 변경
                const data = {
                    characters: state.characters,
                    gameLogs: state.gameLogs,
                    currentDay: state.currentDay
                };

                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "relation_simulation_save.json";
                a.click();

                URL.revokeObjectURL(url);
            };

            /* JSON 데이터 불러오기 */
            const fileInput = document.getElementById("file-input");
            document.getElementById("btn-import").onclick = () => {
                fileInput.click();
            };

            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const data = JSON.parse(ev.target.result);

                        // 수정: state 객체 업데이트
                        state.characters.length = 0;
                        if (data.characters) state.characters.push(...data.characters);

                        state.gameLogs.length = 0;
                        if (data.gameLogs) state.gameLogs.push(...data.gameLogs);

                        state.currentDay = data.currentDay || 1;

                        // 수정: UIManager를 통해 화면 갱신 함수 호출
                        UIManager.renderCharacterList();
                        UIManager.refreshRelationSelectors();
                        UIManager.renderRelationTable();
                        
                        // 로그 화면도 갱신
                        UIManager.renderLogs();

                        alert("데이터를 성공적으로 불러왔습니다.");
                    } catch (err) {
                        console.error(err);
                        alert("잘못된 파일이거나 불러오는 중 오류가 발생했습니다.");
                    }
                };

                reader.readAsText(file);
                // 파일 입력 초기화 (같은 파일 다시 로드 가능하게)
                e.target.value = '';
            };
        </script>
    </body>
</html>
